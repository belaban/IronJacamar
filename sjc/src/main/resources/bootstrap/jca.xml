<deployment>

  <!-- Bean Validation -->
  <bean name="BeanValidation" class="org.jboss.jca.core.bv.BeanValidation">
    <depends>NamingServer</depends>
  </bean>

  <!-- Thread group -->
  <bean name="ThreadGroup"
        class="java.lang.ThreadGroup">
    <constructor>
      <parameter>workmanager</parameter>
    </constructor>
    <ignoreStop/>
    <ignoreDestroy/>
  </bean>

  <!-- Thread factory -->
  <bean name="ThreadFactory"
        interface="java.util.concurrent.ThreadFactory"
        class="org.jboss.threads.JBossThreadFactory">
    <constructor>
      <parameter><inject bean="ThreadGroup"/></parameter>
      <parameter>false</parameter>
      <parameter>5</parameter>
      <parameter>work</parameter>
      <parameter><null/></parameter>
      <parameter><null/></parameter>
    </constructor>
  </bean>

  <!-- Rejecting executor -->
  <bean name="RejectingExecutor">
    <constructor factoryMethod="rejectingExecutor" 
                 factoryClass="org.jboss.threads.JBossExecutors">
    </constructor>
  </bean>

  <!-- TimeUnit -->
  <bean name="KeepAliveTimeUnit">
    <constructor factoryMethod="valueOf" 
                 factoryClass="java.util.concurrent.TimeUnit">
      <parameter>SECONDS</parameter>
    </constructor>
  </bean>

  <!-- Short running thread pool -->
  <bean name="ShortRunningThreadPool" class="org.jboss.threads.QueueExecutor">
    <constructor>
      <!-- Core threads -->
      <parameter>20</parameter>
      <!-- Max threads -->
      <parameter>100</parameter>
      <!-- 60 seconds keepalive -->
      <parameter>60</parameter>
      <parameter><inject bean="KeepAliveTimeUnit"/></parameter>
      <!-- Queue size -->
      <parameter>1024</parameter>
      <!-- Thread factory -->
      <parameter><inject bean="ThreadFactory"/></parameter>
      <!-- Blocking -->
      <parameter>true</parameter>
      <!-- Handoff executor -->
      <parameter><inject bean="RejectingExecutor"/></parameter>
    </constructor>
  </bean>

  <!-- Long running thread pool -->
  <bean name="LongRunningThreadPool" class="org.jboss.threads.QueueExecutor">
    <constructor>
      <!-- Core threads -->
      <parameter>20</parameter>
      <!-- Max threads -->
      <parameter>100</parameter>
      <!-- 60 seconds keepalive -->
      <parameter>60</parameter>
      <parameter><inject bean="KeepAliveTimeUnit"/></parameter>
      <!-- Queue size -->
      <parameter>1024</parameter>
      <!-- Thread factory -->
      <parameter><inject bean="ThreadFactory"/></parameter>
      <!-- Blocking -->
      <parameter>true</parameter>
      <!-- Handoff executor -->
      <parameter><inject bean="RejectingExecutor"/></parameter>
    </constructor>
  </bean>

  <!-- Users / roles -->
  <bean name="UsersRoles"
        interface="org.jboss.jca.core.spi.security.Callback"
        class="org.jboss.jca.core.security.UsersRoles">
    <property name="UsersProperties">${jboss.jca.home}/config/users.properties</property>
    <property name="RolesProperties">${jboss.jca.home}/config/roles.properties</property>
  </bean>

  <!-- Work Manager -->
  <bean name="WorkManager" interface="org.jboss.jca.core.api.WorkManager" class="org.jboss.jca.core.workmanager.WorkManagerImpl">
    <!-- The short running thread pool -->
    <property name="ShortRunningThreadPool"><inject bean="ShortRunningThreadPool"/></property>

    <!-- The long running thread pool -->
    <property name="LongRunningThreadPool"><inject bean="LongRunningThreadPool"/></property>

    <!-- The XA terminator -->
    <property name="XATerminator"><inject bean="TransactionManager" property="XATerminator"/></property>

    <!-- The callback security module -->
    <property name="CallbackSecurity"><inject bean="UsersRoles"/></property>
  </bean>
  
  <!-- Default Bootstrap context -->
  <bean name="DefaultBootstrapContext" 
        interface="org.jboss.jca.core.api.CloneableBootstrapContext"
        class="org.jboss.jca.core.bootstrapcontext.BaseCloneableBootstrapContext">

    <!-- The Transaction Synchronization Registry -->
    <property name="TransactionSynchronizationRegistry"><inject bean="TransactionSynchronizationRegistry"/></property>

    <!-- The Work Manager -->
    <property name="WorkManager"><inject bean="WorkManager"/></property>

    <!-- The XA terminator -->
    <property name="XATerminator"><inject bean="TransactionManager" property="XATerminator"/></property>
  </bean>

  <!-- JNDI strategy -->
  <bean name="JNDIStrategy"
        interface="org.jboss.jca.core.spi.naming.JndiStrategy"
        class="org.jboss.jca.core.naming.SimpleJndiStrategy"/>

  <!-- RA deployer -->
  <bean name="RADeployer" interface="com.github.fungal.spi.deployers.Deployer" class="org.jboss.jca.deployers.fungal.RADeployer">
    <property name="ArchiveValidation">true</property>
    <property name="ArchiveValidationFailOnWarn">false</property>
    <property name="ArchiveValidationFailOnError">true</property>
    <property name="BeanValidation">true</property>
    <property name="PrintStream"><inject bean="JBossStdioContext" property="Out"/></property>
    <property name="DefaultBootstrapContext"><inject bean="DefaultBootstrapContext"/></property>
    <property name="JndiStrategy"><inject bean="JNDIStrategy"/></property>
    <property name="TransactionManager"><inject bean="RealTransactionManager"/></property>
    <depends>BeanValidation</depends>
    <depends>JBossStdioContextSelector</depends>
  </bean>

</deployment>
